cgmake_clear

target test_names {test_names\((.*)\)} -deps {$test_srcdir($target1)/cgdat*.tsv} -code {
	set file [lindex [glob $dep] 0]
	set f [open $file]
	set list {}
	while {![eof $f]} {
		set line [split [gets $f] \t]
		if {![llength $line]} continue
		lappend list [lindex $line 0]
	}
	close $f
	set ::test_names($target1) $list
}

target sum {(.*)/sum-(.*)\.txt} -deps {$test_srcdir($target1)/cgdat*.tsv} -code {
	# var target contains target
	# var target1 contains first braced part of target (= destdir)
	# var target1 contains second braced part of target (= name)
	# var deps contains a list of all dependencies
	# var dep contains the first element of the first dependency (so you do not have to do [lindex $deps 0] to get it)
	for {set i 1} {$i < 5} {incr i} {
		puts "progress $target $i"
		after 250
	}
	set f [open [glob $dep]]
	while {![eof $f]} {
		set line [split [gets $f] \t]
		if {[lindex $line 0] eq $target2} break
	}
	close $f
	puts line=$line
	set o [open $target.temp w]
	set calc [join [lrange $line 1 end] +]
	puts $o $calc=[expr $calc]
	close $o
	file rename $target.temp $target
}

target sum2 {(.*)/sum2-(.*)\.txt} -deps {$target1/sum-$target2.txt} -code {
	for {set i 1} {$i < 5} {incr i} {
		puts "progress $i"
		after 250
	}
	file copy $dep $target.temp
	exec echo 2 >> $target.temp
	file rename $target.temp $target
}

target error_all.txt {(.*)/all.txt} -deps {$target1/notpresent.txt} -code {
	error "This should not be executed, as the dependencies are not fullfilled, the other target is used"
}

target all.txt {(.*)/all.txt} -deps {$target1/sum-$_test_names($target1).txt} -vars {test_header($target1)} -code {
	exec echo $test_header($target1) > $target.temp
	exec cat {*}$deps >> $target.temp
	file rename -force $target.temp $target
}

target test {(.*)/test.finished} -deps {$target1/all.txt $target1/sum2-$_test_names($target1).txt} -code {
	file_write $target done
}

proc cg_maketest {args} {
	set args [cgmake_args {*}$args]
	if {[llength $args] != 3} {
		error "wrong # args: should be cg_maketest.tcl ?options? srcdir destdir header"
	}
	foreach {srcdir destdir header} $args break
	set ::test_srcdir($destdir) $srcdir
	set ::test_header($destdir) $header
	file mkdir $destdir
	cgmake $destdir/test.finished
}

# cg_maketest {*}$argv
